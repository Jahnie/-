<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>ä¿®å¿ƒå…»æ€§è®°</title>
    <style>
        /* ================================================= */
        /* ã€CSS æ ·å¼ï¼šæœ€ç»ˆç‰ˆæœ¬ã€‘ */
        /* ================================================= */
        body {
            background: #f8f4ef;
            font-family: "å®‹ä½“";
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: flex-start;
            height: 100vh;
            padding: 20px;
        }

        #logContainer {
            width: 40%;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        #loginSection {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 0;
            border: none;
            background: #f9e6ea;
            background-color: #f9e6ea;
            border: 1px solid #e4b6c2;
            color: #704848;
            padding: 10px 15px;
            border-radius: 10px 10px 0 0;
        }

        #tipBox {
            flex-grow: 1;
            background: #fff8f2;
            border: 2px solid #cbb8a5;
            border-radius: 0 0 10px 10px;
            padding: 15px;
            color: #5c4631;
            line-height: 1.8;
            font-size: 16px;
            box-shadow: 0 0 6px #e0d1be;
            overflow-y: auto;
        }

        #main {
            width: 50%;
            margin-left: 30px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        button {
            background: #f9e6ea;
            border: none;
            padding: 2px 7px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }

        button:hover {
            background: #d7c1a8;
        }

        .section {
            background: #fffdf8;
            border: 1px solid #d2c0a8;
            border-radius: 3px;
            padding: 15px;
        }

        #scoreBoard {
            font-weight: bold;
            color: #4b3823;
            margin-bottom: 5px;
        }

        #attrBoard {
            background: #fefaf5;
            border: 1px solid #d6c4aa;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 15px;
            color: #5c4631;
        }

        .attr-line {
            display: flex;
            justify-content: space-between;
            padding: 2px 0;
        }

        h3 {
            font-size: 18px;
            margin: 0px 0 7px;
            padding-left: 10px;
        }
        
        /* é•¿æœŸä»»åŠ¡æ¿æ ·å¼ */
        .goal-task {
             background: #fdf5f5;
            border: 1px dashed #d6b4b4;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 15px;
            color: #8b5757;
        }

        .goal-task h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: #a04040;
        }
        
        /* ç§°å·æ ·å¼ */
        .title-item {
            padding: 5px 0;
            border-bottom: 1px dotted #e0d1be;
            color: #5c4631;
        }

        .title-item.unlocked {
            font-weight: bold;
            color: #a04040;
        }

        .title-item .condition {
            font-size: 13px;
            color: #8b5757;
            display: block;
            margin-top: 2px;
        }
    </style>
</head>
<body>
<div id="logContainer">
    <div id="loginSection">
        <button onclick="registerWithEmail()">æ³¨å†Œ</button>
        <button onclick="loginWithEmail()">ç™»å½•</button>
        <button onclick="saveGameData()">ä¿å­˜è¿›åº¦</button>
    </div>
    <div id="tipBox" class="tip-content"></div>
</div>
<div id="main">
    <div id="scoreBoard">å½“å‰ç­‰çº§ï¼šå©‰å¥³ã€€æ€»ç§¯åˆ†ï¼š0</div>
    <div id="attrBoard">
        <div class="attr-line"><span>ğŸŒ¿ å¥åº·ï¼š</span><span id="healthVal">0</span></div>
        <div class="attr-line"><span>ğŸ”¥ ä½“åŠ›ï¼š</span><span id="staminaVal">0</span></div>
        <div class="attr-line"><span>ğŸ§º æ•´æ´ï¼š</span><span id="tidinessVal">0</span></div>
        <div class="attr-line"><span>ğŸª æ„å¿—ï¼š</span><span id="willVal">0</span></div>
        <div class="attr-line"><span>ğŸ•Šï¸ å¿ƒæ€§ï¼š</span><span id="mindVal">0</span></div>
        <div class="attr-line"><span>ğŸ“œ æ‚Ÿæ€§ï¼š</span><span id="wisdomVal">0</span></div>
    </div>

    <div class="goal-task">
        <h4>ğŸ“œ é•¿æœŸä»»åŠ¡ï¼šè¥¿å­¦å…¥é“</h4>
        <div id="westernMedTitleDisplay" style="color:#5c4631;">
            ã€åŒ»è€…ä½¿å‘½ã€‘ï¼šè¥¿æ–¹åŒ»å­¦è‡ªæµ·è·¯ä¼ å…¥ï¼Œå…¶ç–—æ•ˆä»¤äººéœ‡æƒŠã€‚ä½ å¿ƒå¿§è‹ç”Ÿç–¾è‹¦ï¼Œå†³æ„æ”¾ä¸‹æˆè§ï¼Œæ½œå¿ƒé’»ç ”è¥¿åŒ»è§£å‰–ä¸è¯Šç–—ä¹‹æ³•ï¼Œä»¥æ±‚å¾—å…¨èƒ½åŒ»æœ¯ï¼ŒæŠ¤ä¸€æ–¹å¹³å®‰ã€‚
        </div>
        <div id="westernMedGoalDisplay"></div>
    </div>

    <div class="goal-task">
        <h4>ğŸ“š é•¿æœŸä»»åŠ¡ï¼šå²é»„æ‰¿é“</h4>
        <div id="chineseMedTitleDisplay" style="color:#5c4631;">
            ã€ä¼ æ‰¿ä¹‹è´£ã€‘ï¼šä¸­ååŒ»é“åšå¤§ç²¾æ·±ï¼Œè•´å«æµä¸–å…»ç”Ÿä¹‹æ³•ã€‚ä½ æ½œå¿ƒç ”ä¹ å¤ç±ï¼Œä»ç»å…¸ä¸­æ±²å–æ™ºæ…§ï¼Œç«‹å¿—ç»§æ‰¿åŒ»æœ¯è¡£é’µã€‚
        </div>
        <div id="chineseMedGoalDisplay"></div>
    </div>

    <div class="section">
        <h3>ğŸ† ç§°å·æ”¶è—</h3>
        <div id="titleCollectionDisplay" style="margin-top: 5px;">
            </div>
    </div>
    <div class="section">
        <h3>ğŸ“– å­¦ä¹ </h3>
        <select id="subject">
            <option>ä¸­åŒ»å­¦</option>
            <option>é’ˆç¸å­¦</option>
            <option>è¥¿åŒ»å­¦</option>
            <option>è‹±æ–‡</option>
        </select>
        <input id="studyHour" type="number" placeholder="å°æ—¶" min="0" style="width:50px;">æ—¶
        <input id="studyMin" type="number" placeholder="åˆ†é’Ÿ" min="0" style="width:60px;">åˆ†
        <button onclick="study()">ä¿®ä¹ </button>
        <button onclick="noStudy()">å·æ‡’ä¸€æ—¥</button>
    </div>
    
     <div class="section">
        <h3>ğŸ“˜ ç ”è¯»åŒ»ç±</h3>
        <select id="chineseBook">
            <option>ã€Šé©¬æ°æ¸©ç¸æ³•ã€‹</option>
            <option>ã€Šä¸­åŒ»ç¾å®¹çš®è‚¤ç§‘å­¦ã€‹</option>
            <option>ã€Šå›¾è§£é’ˆç¸ç”²ä¹™ç»ã€‹</option>
            <option>ã€Šé’©æ²‰ç´¢éšã€‹</option>
            <option>ã€Šè„‰è¯Šä¸€å­¦å°±ä¼šã€‹</option>
        </select>
        <input id="readHour" type="number" placeholder="å°æ—¶" min="0" style="width:50px;">æ—¶
        <input id="readMin" type="number" placeholder="åˆ†é’Ÿ" min="0" style="width:60px;">åˆ†
        <button onclick="readChineseBook()">ç ”è¯»</button>
    </div>

    <div class="section">
        <h3>ğŸ¥£ é¥®é£Ÿ</h3>
        <button onclick="eat('å¥åº·')">è†³é£Ÿæ¸…æ·¡</button>
        <button onclick="eat('åƒåœ¾')">æ²¹ç‚¸å¥¶èŒ¶æ³¡é¢</button>
    </div>
    <div class="section">
        <h3>ğŸ’ª è¿åŠ¨</h3>
        <button onclick="exercise('æŒé‡é”»ä½“')">æŒé‡é”»ä½“ï¼ˆä¸¾å“‘é“ƒï¼‰</button>
        <button onclick="exercise('ä¿®èº«å…»æ€§')">ä¿®èº«å…»æ€§ï¼ˆè…°éƒ¨é”»ç‚¼ï¼‰</button>
        <button onclick="exercise('èˆ’ç­‹æ´»ç»œ')">èˆ’ç­‹æ´»ç»œï¼ˆæ‹‰ä¼¸ï¼‰</button>
        <button onclick="exercise('èˆåŠ¨é£å')">èˆåŠ¨é£åï¼ˆå¥èº«æ“ï¼‰</button>
    </div>
    
    <div class="section">
        <h3>ğŸ¡ æ—¥å¸¸</h3>
        <button onclick="distractionControl()">ğŸ“º è¿œç¦»æ‚å¿µ</button>
        <button onclick="restControl()">ğŸ§˜ğŸ»â€â™€ï¸ è°ƒæ¯é™å</button>
        <span style="font-weight: bold;">æ‰“æ‰«æ•´ç†ï¼š</span>
        <input id="cleanHour" type="number" placeholder="å°æ—¶" min="0" style="width:50px;">æ—¶
        <input id="cleanMin" type="number" placeholder="åˆ†é’Ÿ" min="0" style="width:60px;">åˆ†
        <button onclick="clean()">åŠ¨æ‰‹æ•´ç†</button>
    </div>
    <div class="section">
        <h3>ğŸª ä»ªå®¹</h3>
        <button onclick="groom('åŒ–å¦†')">æ–½ç²‰é»›</button>
        <button onclick="groom('åˆ·ç‰™')">æ™¨èµ·ç›¥æ´—</button>
        <button onclick="groom('æ´—æ¾¡')">æ²æµ´æ›´è¡£</button>
    </div>
    <div class="section">
        <h3>ğŸ•‰ï¸ å¿µç»</h3>
        <button onclick="chant()">å¿µç»ä¿®è¡Œ</button>
        <button onclick="noChant()">æ€ æ…¢ä¿®è¡Œ</button>
    </div>
</div>
<script>
    // 1. å®šä¹‰å…¨å±€å±æ€§å¯¹è±¡
    window.attr = { health: 0, stamina: 0, tidiness: 0, will: 0, mind: 0, wisdom: 0 };

    // 2. å®šä¹‰å…¨å±€ç›®æ ‡/çŠ¶æ€å¯¹è±¡
    window.goal = {
        westernMedStudyHours: 0,
        chineseMedStudyHours: 0, // ä¸­åŒ»é•¿æœŸä»»åŠ¡è¿›åº¦
        rareTitle: "" // å½“å‰ä½©æˆ´çš„ç§°å·
    };
    // ç›®æ ‡å¸¸é‡
    const WESTERN_MED_GOAL = 50;
    const CHINESE_MED_GOAL = 50; 
    const RARE_TITLE_WEST = "â˜… å¤©æ¶¯åŒ»å¥³ â˜…"; // è¥¿åŒ»æœ€é«˜ç§°å·
    const RARE_TITLE_CHINESE = "ğŸŒŸ æ‰¿é“å¤§åŒ» ğŸŒŸ"; // ä¸­åŒ»æœ€é«˜ç§°å·

    // 3. ç§°å·æ•°æ®ç»“æ„
    window.titles = {
        // è®°å½•å·²è§£é”çš„ç§°å·åˆ—è¡¨
        unlocked: [], 
        // æ‰€æœ‰ç§°å·çš„å®šä¹‰
        definitions: [
            // è¥¿åŒ»é•¿æœŸä»»åŠ¡ç§°å·
            { 
                name: RARE_TITLE_WEST, 
                desc: "å­¦è´¯ä¸­è¥¿ï¼Œå¿ƒæ€€å¤©ä¸‹ï¼Œä»¥åŒ»æµä¸–ã€‚", 
                conditionKey: 'westernMedStudyHours', 
                conditionValue: WESTERN_MED_GOAL
            },
            // ä¸­åŒ»é•¿æœŸä»»åŠ¡ç§°å· 
             { 
                name: RARE_TITLE_CHINESE, 
                desc: "ç©·æå²é»„ä¹‹æœ¯ï¼Œå¾—å¤©åœ°äººå’Œä¹‹çœŸè°›ã€‚", 
                conditionKey: 'chineseMedStudyHours', 
                conditionValue: CHINESE_MED_GOAL
            },
            // æ•´æ´å±æ€§ç§°å·
            {
                name: "ğŸŒ¸ ä¼˜é›…ä½³äºº ğŸŒ¸",
                desc: "ä¸¾æ­¢å¾—ä½“ï¼Œä»ªå®¹æ•´æ´ï¼Œç¤¾ä¼šäº¤é™…çš„æ¥·æ¨¡ã€‚",
                conditionKey: 'tidiness',
                conditionValue: 50
            },
            // ä½“åŠ›å±æ€§ç§°å· (ç£çŸ³ä¹‹å¿—)
            {
                name: "â›°ï¸ ç£çŸ³ä¹‹å¿— â›°ï¸",
                desc: "èº«å¼ºä½“å£®ï¼Œæ„å¿—åšå®šï¼Œä½“åŠ›ä¸å¥åº·çš„æé™ã€‚",
                conditionKey: 'stamina',
                conditionValue: 50
            }
        ]
    };

    // å·¥å…·å‡½æ•°
    function getSyncDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getDisplayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    function totalScore(){
        return window.attr.health + window.attr.stamina + window.attr.tidiness + window.attr.will + window.attr.mind + window.attr.wisdom;
    }

    function levelName(){
        const t = totalScore();
        if(t>=150) return "å¤§æˆ";
        if(t>=100) return "ä½³äºº";
        if(t>=60) return "çŸ¥å¥³";
        if(t>=30) return "æ‰å¥³";
        return "å©‰å¥³";
    }
    
    function updateTitleCollectionDisplay() {
        const container = document.getElementById('titleCollectionDisplay');
        container.innerHTML = '';

        window.titles.definitions.forEach(title => {
            const isUnlocked = window.titles.unlocked.includes(title.name);
            const item = document.createElement('div');
            item.className = 'title-item' + (isUnlocked ? ' unlocked' : '');
            
            let currentValue;
            // æ£€æŸ¥æ˜¯å±æ€§è¿˜æ˜¯é•¿æœŸç›®æ ‡
             if (window.attr.hasOwnProperty(title.conditionKey)) {
                currentValue = window.attr[title.conditionKey];
            } else if (window.goal.hasOwnProperty(title.conditionKey)) {
                currentValue = window.goal[title.conditionKey];
            } else {
                return; 
            }

            const displayValue = currentValue.toFixed(1);
            
            if (isUnlocked) {
                item.innerHTML = `
                    ${title.name} 
                    <span class="condition" style="color:#a04040;"> (å·²è§£é”) </span>
                `;
            } else {
                item.innerHTML = `
                    ${title.name} 
                    <span class="condition">(æœªè§£é”) è¿›åº¦: ${displayValue} / ${title.conditionValue}</span>
                `;
            }
            container.appendChild(item);
        });

        if (container.children.length === 0) {
            container.innerText = "ï¼ˆå°šæ— ç§°å·è®°å½•ï¼‰";
        }
    }


    function updateGoalDisplay(){
        // è¥¿å­¦å…¥é“
        const currentW = window.goal.westernMedStudyHours;
        const goalW = WESTERN_MED_GOAL;
        const displayW = document.getElementById('westernMedGoalDisplay');
        
        if(currentW >= goalW) {
             displayW.innerText = `è¥¿åŒ»å­¦è¿›åº¦ï¼šå·²è¾¾æˆç›®æ ‡ï¼ˆ${currentW.toFixed(2)} / ${goalW} å°æ—¶ï¼‰`;
             document.getElementById('westernMedTitleDisplay').style.color = '#a04040';
        } else {
             displayW.innerText = `è¥¿åŒ»å­¦è¿›åº¦ï¼š${Math.min(currentW, goalW).toFixed(2)} / ${goalW} å°æ—¶`;
             document.getElementById('westernMedTitleDisplay').style.color = '#5c4631';
        }

        // å²é»„æ‰¿é“
        const currentC = window.goal.chineseMedStudyHours;
        const goalC = CHINESE_MED_GOAL;
        const displayC = document.getElementById('chineseMedGoalDisplay');
        
        if(currentC >= goalC) {
             displayC.innerText = `ä¸­åŒ»ç ”è¯»è¿›åº¦ï¼šå·²è¾¾æˆç›®æ ‡ï¼ˆ${currentC.toFixed(2)} / ${goalC} å°æ—¶ï¼‰`;
             document.getElementById('chineseMedTitleDisplay').style.color = '#a04040';
        } else {
             displayC.innerText = `ä¸­åŒ»ç ”è¯»è¿›åº¦ï¼š${Math.min(currentC, goalC).toFixed(2)} / ${goalC} å°æ—¶`;
             document.getElementById('chineseMedTitleDisplay').style.color = '#5c4631';
        }
    }

    function updateDisplay(){
        let scoreTitle = `å½“å‰ç­‰çº§ï¼š${levelName()}ã€€æ€»ç§¯åˆ†ï¼š${Math.round(totalScore())}`;
        if (window.goal.rareTitle) {
            scoreTitle += `ã€€${window.goal.rareTitle}`;
        }
        document.getElementById('scoreBoard').innerText = scoreTitle;
        document.getElementById('healthVal').innerText = window.attr.health.toFixed(1);
        document.getElementById('staminaVal').innerText = window.attr.stamina.toFixed(1);
        document.getElementById('tidinessVal').innerText = window.attr.tidiness.toFixed(1);
        document.getElementById('willVal').innerText = window.attr.will.toFixed(1);
        document.getElementById('mindVal').innerText = window.attr.mind.toFixed(1);
        document.getElementById('wisdomVal').innerText = window.attr.wisdom.toFixed(1);
        updateGoalDisplay();
        updateTitleCollectionDisplay(); 
    }
    window.updateDisplay = updateDisplay;

    function addTip(text){
        const tipBox = document.getElementById('tipBox');
        const p = document.createElement('div');
        const date = getDisplayDate();
        p.innerText = `[${date}] ${text}`;
        tipBox.prepend(p);
    }
    window.addTip = addTip;

    window.lastDailyTipDate = "";

    function showDailyTip(fromLoadGame = false) {
        const todaySyncDate = getSyncDate();
        const todayDisplayDate = getDisplayDate();
        const dailyTip = "ğŸŒ¸ æ¸…æ™¨å¾®å…‰ï¼Œé™å€™ä¿®è¡Œå§‹ã€‚";
        const tipBox = document.getElementById('tipBox');

        if (window.lastDailyTipDate !== todaySyncDate) {
            const p = document.createElement('div');
            p.innerText = `[${todayDisplayDate}] ${dailyTip}`;
            tipBox.prepend(p);
            console.log(`[${todaySyncDate}] æ–°çš„ä¸€å¤©ï¼Œå·²æ·»åŠ æ¯æ—¥æç¤ºã€‚`);
            window.lastDailyTipDate = todaySyncDate;
            if (window.saveGameData) {
                window.saveGameData(true, true);
            }
        }
        else if (fromLoadGame && tipBox.children.length === 0) {
            addTip("ğŸ™ å­˜æ¡£åŠ è½½å®Œæ¯•ï¼Œç»§ç»­æ‚¨çš„ä¿®å¿ƒä¹‹æ—…ã€‚");
        }
    }
    window.showDailyTip = showDailyTip;

    updateDisplay();
    window.addEventListener('load', () => showDailyTip(false));


    function checkTitleUnlock() {
        let newTitleUnlocked = false;
        
        window.titles.definitions.forEach(title => {
            const isUnlocked = window.titles.unlocked.includes(title.name);
            
            if (!isUnlocked) {
                let currentValue;
                // è·å–å½“å‰å±æ€§/é•¿æœŸä»»åŠ¡å€¼
                if (window.attr.hasOwnProperty(title.conditionKey)) {
                    currentValue = window.attr[title.conditionKey];
                } else if (window.goal.hasOwnProperty(title.conditionKey)) {
                    currentValue = window.goal[title.conditionKey];
                } else {
                    return; 
                }

                if (currentValue >= title.conditionValue) {
                    window.titles.unlocked.push(title.name);
                    
                    // è‡ªåŠ¨ä½©æˆ´ç¨€æœ‰ç§°å·
                    if (title.name === RARE_TITLE_WEST || title.name === RARE_TITLE_CHINESE) {
                        window.goal.rareTitle = title.name;
                    }
                    
                    addTip(`ğŸ‰ **æ­å–œï¼æ‚¨å·²è§£é”æ–°ç§°å·ã€${title.name}ã€‘ï¼**`);
                    newTitleUnlocked = true;
                }
            }
        });

        if (newTitleUnlocked) {
            updateDisplay();
        }
    }

    // =========================================================
    // ã€æ ¸å¿ƒé€»è¾‘å‡½æ•°ã€‘
    // =========================================================

    function study(){
        const subject = document.getElementById('subject').value;
        let hour = parseFloat(document.getElementById('studyHour').value) || 0;
        let min = parseFloat(document.getElementById('studyMin').value) || 0;
        let totalHour = hour + min/60;

        if(totalHour <= 0){
            addTip("æ— å¿ƒäºä¹¦å·ï¼Œæ—¶å…‰æ‚„ç„¶æºœèµ°â€¦â€¦");
            return;
        }

        let gain = totalHour * 2;
        let staminaCost = totalHour * 1.5;

        if (window.attr.stamina < staminaCost) {
            addTip(`ä½“åŠ›ä¸è¶³ï¼ç ”ä¹  ${totalHour.toFixed(1)} å°æ—¶éœ€ ${staminaCost.toFixed(1)} ç‚¹ä½“åŠ›ï¼Œè¯·å…ˆä¼‘æ¯æˆ–é”»ç‚¼ã€‚`);
            return;
        }

        window.attr.stamina -= staminaCost;
        window.attr.wisdom += gain;
        window.attr.will += gain * 0.5;
        
        let studyTips;

        if (subject === 'è¥¿åŒ»å­¦') {
            window.goal.westernMedStudyHours += totalHour;
            // é•¿æœŸä»»åŠ¡èƒŒæ™¯æç¤º
            studyTips = [
                `ä½ ç¿»é˜…ç€æ³›é»„çš„è¥¿åŒ»æ•™æï¼Œå­—é‡Œè¡Œé—´çš†æ˜¯æ–°å¤§é™†çš„çŸ¥è¯†ã€‚æ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ï¼Œä½“åŠ›ï¼${staminaCost.toFixed(1)}ã€‚`,
                `çª—å¤–æ˜¯ä¸­å¼åº­é™¢ï¼Œæ¡ˆå‰æ˜¯è¥¿æ´‹åŒ»å…¸ï¼Œä¸­è¥¿èåˆçš„é“è·¯è‰°éš¾è€Œæ¼«é•¿ã€‚æ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ï¼Œä½“åŠ›ï¼${staminaCost.toFixed(1)}ã€‚`,
                `ä¸ºæ±‚æµä¸–ä¹‹é“ï¼Œä½ åŸ‹å¤´è‹¦è¯»ã€‚é‚£å¥â€œåŒ»æœ¯ä¸åˆ†ä¸­è¥¿ï¼Œå”¯æµä¸–ä¸ºå¤§â€åœ¨ä½ å¿ƒä¸­å›è¡ã€‚æ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ï¼Œä½“åŠ›ï¼${staminaCost.toFixed(1)}ã€‚`
            ];
        } else {
            studyTips = [
                `ç¯ä¸‹æŒ‘ç¯ç ”è¯»ã€Š${subject}ã€‹ï¼Œç¬”å¢¨ç”Ÿé¦™ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ï¼Œä½“åŠ›ï¼${staminaCost.toFixed(1)}ã€‚`,
                `è½»å¯ä¹¦å·ï¼Œæ˜¥é£æ‹‚é¢ï¼Œç ”ä¹ ã€Š${subject}ã€‹æœ‰æˆï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ï¼Œä½“åŠ›ï¼${staminaCost.toFixed(1)}ã€‚`
            ];
        }
        
        addTip(studyTips[Math.floor(Math.random() * studyTips.length)]);
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.study = study;

    // ç ”è¯»ä¸­åŒ»ä¹¦ç±çš„å‡½æ•°
    function readChineseBook() {
        const bookName = document.getElementById('chineseBook').value;
        let hour = parseFloat(document.getElementById('readHour').value) || 0;
        let min = parseFloat(document.getElementById('readMin').value) || 0;
        let totalHour = hour + min/60;

        if(totalHour <= 0){
            addTip("å¿ƒç¥ä¸å®ï¼Œç ”è¯»å¾’åŠ³ã€‚");
            return;
        }

        // ä¸­åŒ»ç ”è¯»æ³¨é‡å¿ƒæ€§
        let wisdomGain = totalHour * 1.8;
        let mindGain = totalHour * 1.5; 
        let staminaCost = totalHour * 1.2; 

        if (window.attr.stamina < staminaCost) {
            addTip(`ä½“åŠ›ä¸è¶³ï¼ç ”è¯» ${totalHour.toFixed(1)} å°æ—¶éœ€ ${staminaCost.toFixed(1)} ç‚¹ä½“åŠ›ã€‚`);
            return;
        }

        window.attr.stamina -= staminaCost;
        window.attr.wisdom += wisdomGain;
        window.attr.mind += mindGain;
        window.goal.chineseMedStudyHours += totalHour; // å¢åŠ é•¿æœŸä»»åŠ¡è¿›åº¦

        const tip = `ç„šé¦™é™åï¼Œç ”è¯»ã€Š${bookName}ã€‹${totalHour.toFixed(1)}å°æ—¶ã€‚æ‚Ÿæ€§ï¼‹${wisdomGain.toFixed(1)}ï¼Œå¿ƒæ€§ï¼‹${mindGain.toFixed(1)}ï¼Œä½“åŠ›ï¼${staminaCost.toFixed(1)}ã€‚`;
        
        addTip(tip);
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.readChineseBook = readChineseBook;


    function noStudy(){
        window.attr.will -= 1;
        window.attr.wisdom -= 1;
        addTip("ä¸€æ—¥å·æ‡’ï¼Œä¹¦å·è’™å°˜ï¼Œæ‚Ÿæ€§ï¼1ï¼Œæ„å¿—ï¼1ã€‚");
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.noStudy = noStudy;

    function eat(type){
        if(type === 'å¥åº·'){
            window.attr.health += 1;
            addTip("é’è”¬æ·¡é¥­ï¼Œæ¸…å¿ƒå¯¡æ¬²ï¼Œæ°”è¡€è°ƒå’Œï¼Œå¥åº·ï¼‹1ã€‚");
        } else {
            window.attr.health -= 2;
            addTip("æ²¹ç‚¸å¥¶èŒ¶æ³¡é¢å…¥è…¹ï¼Œè„¾èƒƒä¸é€‚ï¼Œå¥åº·ï¼2ã€‚");
        }
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.eat = eat;

    function exercise(type){
        let tip;
        if(type === "æŒé‡é”»ä½“"){
            window.attr.stamina += 1.5;
            window.attr.health += 1;
            tip = [ "ä¸¾é“å¦‚å±±ï¼Œæ°”è¡€ç•…é€šï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚", "æ²‰å¿ƒé”¤ç‚¼ï¼Œç­‹éª¨èˆ’å±•ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚", "åŠ›è¡Œé”»ä½“ï¼Œæ°”è¡€æµç•…ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚" ];
        }
        if(type === "ä¿®èº«å…»æ€§"){
            window.attr.stamina += 1;
            window.attr.will += 0.5;
            tip = [ "è½»èˆ’è…°è‚¢ï¼Œæ°”å®šç¥é—²ï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚", "è…°èº«è½»æ—‹ï¼Œå¿ƒé™å¦‚æ°´ï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚", "é™å¿ƒå…»æ€§ï¼Œèˆ’å±•èº«å¿ƒï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚" ];
        }
        if(type === "èˆ’ç­‹æ´»ç»œ"){
            window.attr.health += 1;
            window.attr.mind += 0.5;
            tip = [ "ç­‹éª¨èˆ’å±•ï¼Œå¿ƒå¢ƒæ¸…å®ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚", "è½»è½»èˆ’å±•ï¼Œèº«å¿ƒæ„‰æ‚¦ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚", "ç­‹éª¨ç•…é€šï¼Œæ°”è¡€æµåŠ¨ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚" ];
        }
        if(type === "èˆåŠ¨é£å"){
            window.attr.stamina += 1.5;
            window.attr.health += 1.0;
            tip = [ "èˆåŠ¨é£åï¼Œæ°”è¡€æµç•…ï¼Œèº«å¿ƒåˆä¸€ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1.0ã€‚", "èˆæ­¥è½»ç›ˆï¼Œç¥é‡‡å¥•å¥•ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1.0ã€‚", "èˆå§¿ç¿©è·¹ï¼Œæ°”è¡€é¡ºç•…ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1.0ã€‚" ];
        }
        addTip(tip[Math.floor(Math.random() * tip.length)]);
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.exercise = exercise;
    
    // ã€æ–°å¢ã€‘è¿œç¦»æ‚å¿µ (å¯¹åº”ä¸çœ‹çŸ­è§†é¢‘/å°è¯´)
    function distractionControl(){
        window.attr.will += 1.5;
        window.attr.mind += 1.5;
        addTip("æ‘’å¼ƒçŸ­è§†é¢‘å’Œå°è¯´ï¼Œå¿ƒå¦‚æ­¢æ°´ï¼Œæ„å¿—ï¼‹1.5ï¼Œå¿ƒæ€§ï¼‹1.5ã€‚");
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.distractionControl = distractionControl;

    // ã€æ–°å¢ã€‘è°ƒæ¯é™å (å¯¹åº”ä¼‘æ¯/æ”¾æ¾)
    function restControl(){
        window.attr.stamina += 2.0;
        window.attr.mind += 0.5;
        addTip("è°ƒæ¯é™åï¼Œæ”¾æ¾èº«å¿ƒï¼Œä½“åŠ›ï¼‹2.0ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚");
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.restControl = restControl;


    // ä¿®æ”¹åçš„ clean() å‡½æ•°ï¼šåŠ å…¥æ—¶é—´é‡åŒ–
    function clean(){
        let hour = parseFloat(document.getElementById('cleanHour').value) || 0;
        let min = parseFloat(document.getElementById('cleanMin').value) || 0;
        let totalHour = hour + min/60;

        if(totalHour <= 0){
            addTip("æˆ¿é—´ç•¥æ˜¾å‡Œä¹±ï¼Œä½†ä½ ä»Šæ—¥æ— å¿ƒæ•´ç†ã€‚");
            return;
        }

        // æ•´ç†å¥–åŠ±è®¡ç®—
        const tidinessGain = totalHour * 2.0;
        const staminaGain = totalHour * 1.0;
        const mindGain = totalHour * 0.5;

        window.attr.tidiness += tidinessGain;
        window.attr.stamina += staminaGain;
        window.attr.mind += mindGain;

        const tip = `ä½ æ‰“æ‰«æ•´ç†äº† ${totalHour.toFixed(1)} å°æ—¶ã€‚ç¯å¢ƒä¸€æ–°ï¼Œå¿ƒå¢ƒæ¾„æ˜ï¼šæ•´æ´ï¼‹${tidinessGain.toFixed(1)}ï¼Œä½“åŠ›ï¼‹${staminaGain.toFixed(1)}ï¼Œå¿ƒæ€§ï¼‹${mindGain.toFixed(1)}ã€‚`;
        
        addTip(tip);
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.clean = clean;

    function groom(type){
        let tip;
        if(type==="åŒ–å¦†"){ window.attr.will += 1; tip = "è½»æ–½ç²‰é»›ï¼Œæ˜çœ¸å–„çï¼Œç¥é‡‡å¥•å¥•ï¼Œæ„å¿—ï¼‹1ã€‚"; }
        if(type==="åˆ·ç‰™"){ window.attr.tidiness += 0.5; tip = "å£é½¿æ¸…èŠ¬ï¼Œå¦‚ç‰ç”Ÿè¾‰ï¼Œæ•´æ´ï¼‹0.5ã€‚"; }
        if(type==="æ´—æ¾¡"){ window.attr.tidiness += 1; tip = "æ¸©æ³‰è½»é›¾ï¼Œæ´—å»ç–²ä¹ï¼Œèº«å¿ƒä¿±å‡€ï¼Œæ•´æ´ï¼‹1ã€‚"; }
        addTip(tip);
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.groom = groom;

    function chant(){
        window.attr.mind += 1;
        window.attr.will += 1;
        addTip("é™å¿ƒè¯µç»ï¼Œå¿ƒçµæ¾„å‡€ï¼Œå¿ƒæ€§ï¼‹1ï¼Œå®šåŠ›ï¼‹1ã€‚");
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.chant = chant;

    function noChant(){
        window.attr.will -= 1;
        window.attr.mind -= 1;
        addTip("å¿ƒæµ®æ°”èºï¼Œå¿µç»ä¸ä¸“ï¼Œå¿ƒæ€§ï¼1ï¼Œå®šåŠ›ï¼1ã€‚");
        updateDisplay();
        checkTitleUnlock(); 
    }
    window.noChant = noChant;


    // =========================================================
    // ã€Firebase æ¨¡å—ã€‘
    // =========================================================
</script>
<script type="module">
    // è¯·æ³¨æ„ï¼š
    // 1. Firebase API Key åœ¨æ­¤å¤„æä¾›ï¼Œç”¨äºäº‘ç«¯å­˜å‚¨æ‚¨çš„æ¸¸æˆè¿›åº¦ã€‚
    // 2. æ‚¨éœ€è¦ä½¿ç”¨ã€æ³¨å†Œã€‘åŠŸèƒ½æ¥åˆ›å»ºè´¦å·ï¼Œå¹¶ä½¿ç”¨ã€ä¿å­˜è¿›åº¦ã€‘æ¥ä¸Šä¼ æ•°æ®ã€‚
    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaLeQq_L5JUSQpZ_0jQlHeWm3pXnoxd5g",
      authDomain: "mylifeproject-4712e.firebaseapp.com",
      projectId: "mylifeproject-4712e",
      storageBucket: "mylifeproject-4712e.firebasestorage.app",
      messagingSenderId: "326417385505",
      appId: "1:326417385505:web:f352dacda0da35fb17bb60"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    let currentUser = null;
    let isDataLoaded = false; 

    function getTipsFromDisplay() {
        const tipBox = document.getElementById('tipBox');
        const children = Array.from(tipBox.children);
        return children.map(child => child.innerText);
    }

    function displayTips(tipsArray) {
        const tipBox = document.getElementById('tipBox');
        tipBox.innerHTML = '';
        [...tipsArray].reverse().forEach(tipText => {
            const p = document.createElement('div');
            p.innerText = tipText;
            tipBox.prepend(p);
        });
        const greeting = document.createElement('div');
        greeting.innerText = `--- [${new Date().toLocaleString('zh-CN')}] å­˜æ¡£åŠ è½½å®Œæˆ ---`;
        tipBox.prepend(greeting);
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loadGameData(true);
        } else {
            currentUser = null;
            isDataLoaded = false;
        }
    });

    function registerWithEmail() {
        const email = prompt("è¯·è¾“å…¥æ‚¨çš„é‚®ç®±");
        const password = prompt("è¯·è¾“å…¥æ‚¨çš„å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰");
        if (!email || !password) {
            alert("é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }
        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                alert("æ³¨å†ŒæˆåŠŸï¼Œå·²ä¸ºæ‚¨ä¿å­˜åˆå§‹è¿›åº¦ï¼");
                Object.assign(window.attr, {health: 0, stamina: 0, tidiness: 0, will: 0, mind: 0, wisdom: 0});
                Object.assign(window.goal, {westernMedStudyHours: 0, chineseMedStudyHours: 0, rareTitle: ""}); 
                window.titles.unlocked = []; 
                window.lastDailyTipDate = window.getSyncDate();
                if (window.updateDisplay) window.updateDisplay();
                isDataLoaded = true; 
                saveGameData(true);
            })
            .catch((error) => {
                console.error("æ³¨å†Œå¤±è´¥", error);
                alert(`æ³¨å†Œå¤±è´¥: ${error.message}`);
            });
    }

    function loginWithEmail() {
        const email = prompt("è¯·è¾“å…¥æ‚¨çš„é‚®ç®±");
        const password = prompt("è¯·è¾“å…¥æ‚¨çš„å¯†ç ");
        if (!email || !password) {
            alert("é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }
        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                alert("ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åŠ è½½å­˜æ¡£...");
            })
            .catch((error) => {
                console.error("ç™»å½•å¤±è´¥", error);
                alert(`ç™»å½•å¤±è´¥: ${error.message}`);
            });
    }

    async function saveGameData(isInitialSave = false, isDateOnlySave = false) {
        if (!currentUser) {
            if (!isDateOnlySave) alert("è¯·å…ˆç™»å½•æˆ–æ³¨å†Œæ‰èƒ½ä¿å­˜æ•°æ®ï¼");
            return;
        }

        if (!isInitialSave && !isDateOnlySave && !isDataLoaded) {
            alert("âš ï¸ å±é™©ï¼šäº‘ç«¯å­˜æ¡£å°šæœªåŠ è½½å®Œæˆï¼\nä¸ºäº†é˜²æ­¢è¦†ç›–æ‚¨çš„æ—§å­˜æ¡£ï¼Œè¯·ç­‰å¾…åŠ è½½å®Œæ¯•ï¼Œæˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
            return;
        }

        const userDocRef = doc(db, "users", currentUser.uid);
        if (typeof window.attr !== 'object' || window.attr === null) {
              console.error("æ— æ³•ä¿å­˜ï¼šwindow.attr ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡");
              return;
        }
        
        const dataToSave = {
            attributes: window.attr,
            goals: window.goal,
            unlockedTitles: window.titles.unlocked, 
            tips: getTipsFromDisplay(),
            lastSave: new Date().toLocaleString('zh-CN'),
            lastDailyTipDate: window.lastDailyTipDate || "",
        };

        try {
            await setDoc(userDocRef, dataToSave, { merge: true });
            if (!isInitialSave && !isDateOnlySave) {
                alert("æ¸¸æˆæ•°æ®ä¿å­˜æˆåŠŸï¼");
            }
        } catch (e) {
            console.error("æ•°æ®å†™å…¥å¤±è´¥ï¼š", e);
            if (!isDateOnlySave) alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
        }
    }

    async function loadGameData(isAutoLoad = false) {
        if (!currentUser) return;
        const userDocRef = doc(db, "users", currentUser.uid);
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(data.attributes) Object.assign(window.attr, data.attributes);
                if(data.goals) {
                    // ç¡®ä¿åŠ è½½æ‰€æœ‰ç›®æ ‡ï¼ŒåŒ…æ‹¬æ–°çš„ç›®æ ‡
                    Object.assign(window.goal, {westernMedStudyHours: 0, chineseMedStudyHours: 0, rareTitle: ""}, data.goals);
                } else {
                    Object.assign(window.goal, {westernMedStudyHours: 0, chineseMedStudyHours: 0, rareTitle: ""});
                }
                
                // åŠ è½½å·²è§£é”ç§°å·
                window.titles.unlocked = data.unlockedTitles || [];

                if (window.updateDisplay) window.updateDisplay();

                if (data.tips && Array.isArray(data.tips)) {
                    displayTips(data.tips);
                } else {
                    displayTips([]);
                    const welcomeMsg = document.createElement('div');
                    welcomeMsg.innerText = `[${new Date().toLocaleString('zh-CN')}] æ¬¢è¿å›æ¥ï¼Œ${currentUser.email}ï¼æœªæ‰¾åˆ°å†å²è®°å½•ï¼Œè¯·ç»§ç»­ä¿®è¡Œã€‚`;
                    document.getElementById('tipBox').prepend(welcomeMsg);
                }              
                window.lastDailyTipDate = data.lastDailyTipDate || "";                 

                isDataLoaded = true; 
                console.log("å­˜æ¡£åŠ è½½å®Œæ¯•ï¼Œè§£é”ä¿å­˜åŠŸèƒ½ã€‚");

                if (window.showDailyTip) window.showDailyTip(true);
            } else if (!isAutoLoad) {
                alert("æœªæ‰¾åˆ°æ‚¨çš„æ¸¸æˆå­˜æ¡£ï¼Œè¯·è¿›è¡Œæ¸¸æˆæ“ä½œåç‚¹å‡»ã€ä¿å­˜è¿›åº¦ã€‘ï¼");
                isDataLoaded = true; 
            }
        } catch (e) {
            console.error("æ•°æ®è¯»å–å¤±è´¥ï¼š", e);
            isDataLoaded = false; 
            if (!isAutoLoad) {
                alert("æ•°æ®è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
            }
        }
    }

    window.registerWithEmail = registerWithEmail;
    window.loginWithEmail = loginWithEmail;
    window.saveGameData = saveGameData;
</script>
</body>
</html>