<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ä¿®å¿ƒå…»æ€§è®°</title>
<style>
/* ================================================= */
/* ã€CSS æ ·å¼ï¼šæœ€ç»ˆç‰ˆæœ¬ã€‘ */
/* ================================================= */
body { background: #f8f4ef; font-family: "å®‹ä½“"; display: flex; flex-direction: row; justify-content: center; align-items: flex-start; height: 100vh; padding: 20px;}
#logContainer { width: 40%; display: flex; flex-direction: column; height: 100%;}
#loginSection { display: flex; justify-content: center; gap: 10px; margin-top: 0; border: none; background: #f9e6ea; background-color: #f9e6ea; border: 1px solid #e4b6c2; color: #704848; padding: 10px 15px; border-radius: 10px 10px 0 0;}
#tipBox { flex-grow: 1; background: #fff8f2; border: 2px solid #cbb8a5; border-radius: 0 0 10px 10px; padding: 15px; color: #5c4631; line-height: 1.8; font-size: 16px; box-shadow: 0 0 6px #e0d1be; overflow-y: auto;}
#main { width: 50%; margin-left: 30px; display: flex; flex-direction: column; gap: 8px;}
button { background: #f9e6ea; border: none; padding: 2px 7px; border-radius: 8px; cursor: pointer; font-size: 14px;}
button:hover { background: #d7c1a8;}
.section { background: #fffdf8; border: 1px solid #d2c0a8; border-radius: 3px; padding: 15px;}
#scoreBoard { font-weight: bold; color: #4b3823; margin-bottom: 5px;}
#attrBoard { background: #fefaf5; border: 1px solid #d6c4aa; border-radius: 10px; padding: 10px; margin-bottom: 8px; font-size: 15px; color: #5c4631;}
.attr-line { display: flex; justify-content: space-between; padding: 2px 0;}
h3 { font-size: 18px; margin: 0px 0 7px; padding-left: 10px;}
#goalBoard { background: #fdf5f5; border: 1px dashed #d6b4b4; border-radius: 10px; padding: 10px; margin-bottom: 8px; font-size: 15px; color: #8b5757; }
#goalBoard h4 { margin: 0 0 5px 0; font-size: 16px; color: #a04040;}
</style>
</head>
<body>

<div id="logContainer">
    <div id="loginSection">
        <button onclick="registerWithEmail()">æ³¨å†Œ</button>
        <button onclick="loginWithEmail()">ç™»å½•</button>
        <button onclick="saveGameData()">ä¿å­˜è¿›åº¦</button>
    </div>
    <div id="tipBox" class="tip-content"></div>
</div>

<div id="main">
    <div id="scoreBoard">å½“å‰ç­‰çº§ï¼šå©‰å¥³ã€€æ€»ç§¯åˆ†ï¼š0</div>
    <div id="attrBoard">
        <div class="attr-line"><span>ğŸŒ¿ å¥åº·ï¼š</span><span id="healthVal">0</span></div>
        <div class="attr-line"><span>ğŸ”¥ ä½“åŠ›ï¼š</span><span id="staminaVal">0</span></div>
        <div class="attr-line"><span>ğŸ§º æ•´æ´ï¼š</span><span id="tidinessVal">0</span></div>
        <div class="attr-line"><span>ğŸª æ„å¿—ï¼š</span><span id="willVal">0</span></div>
        <div class="attr-line"><span>ğŸ•Šï¸ å¿ƒæ€§ï¼š</span><span id="mindVal">0</span></div>
        <div class="attr-line"><span>ğŸ“œ æ‚Ÿæ€§ï¼š</span><span id="wisdomVal">0</span></div>
    </div>

    <div id="goalBoard">
        <h4>ğŸ¯ ç›®æ ‡ï¼šè¥¿å­¦å…¥é“</h4>
        <div id="westernMedTitleDisplay"></div>
        <div id="westernMedGoalDisplay"></div>
    </div>

    <div class="section">
        <h3>ğŸ“– å­¦ä¹ </h3>
        <select id="subject">
            <option>ä¸­åŒ»å­¦</option>
            <option>é’ˆç¸å­¦</option>
            <option>è¥¿åŒ»å­¦</option>
            <option>è‹±æ–‡</option>
        </select>
        <input id="studyHour" type="number" placeholder="å°æ—¶" min="0" style="width:50px;">æ—¶
        <input id="studyMin" type="number" placeholder="åˆ†é’Ÿ" min="0" style="width:60px;">åˆ†
        <button onclick="study()">ä¿®ä¹ </button>
        <button onclick="noStudy()">å·æ‡’ä¸€æ—¥</button>
    </div>

    <div class="section">
        <h3>ğŸ¥£ é¥®é£Ÿ</h3>
        <button onclick="eat('å¥åº·')">è†³é£Ÿæ¸…æ·¡</button>
        <button onclick="eat('åƒåœ¾')">æ²¹ç‚¸å¥¶èŒ¶æ³¡é¢</button>
    </div>

    <div class="section">
        <h3>ğŸ’ª è¿åŠ¨</h3>
        <button onclick="exercise('æŒé‡é”»ä½“')">æŒé‡é”»ä½“ï¼ˆä¸¾å“‘é“ƒï¼‰</button>
        <button onclick="exercise('ä¿®èº«å…»æ€§')">ä¿®èº«å…»æ€§ï¼ˆè…°éƒ¨é”»ç‚¼ï¼‰</button>
        <button onclick="exercise('èˆ’ç­‹æ´»ç»œ')">èˆ’ç­‹æ´»ç»œï¼ˆæ‹‰ä¼¸ï¼‰</button>
        <button onclick="exercise('èˆåŠ¨é£å')">èˆåŠ¨é£åï¼ˆå¥èº«æ“ï¼‰</button>
    </div>

    <div class="section">
        <h3>ğŸ¡ æ—¥å¸¸</h3>
        <button onclick="cook()">çƒ¹é¥ªè†³é£Ÿ</button>
        <button onclick="clean()">æ‰“æ‰«æˆ¿é—´</button>
    </div>

    <div class="section">
        <h3>ğŸª ä»ªå®¹</h3>
        <button onclick="groom('åŒ–å¦†')">æ–½ç²‰é»›</button>
        <button onclick="groom('åˆ·ç‰™')">æ™¨èµ·ç›¥æ´—</button>
        <button onclick="groom('æ´—æ¾¡')">æ²æµ´æ›´è¡£</button>
    </div>

    <div class="section">
        <h3>ğŸ•‰ï¸ å¿µç»</h3>
        <button onclick="chant()">å¿µç»ä¿®è¡Œ</button>
        <button onclick="noChant()">æ€ æ…¢ä¿®è¡Œ</button>
    </div>
</div>

<script>
    // 1. å®šä¹‰å…¨å±€å±æ€§å¯¹è±¡
    window.attr = { health: 0, stamina: 0, tidiness: 0, will: 0, mind: 0, wisdom: 0 };
    
    // 2. å®šä¹‰å…¨å±€ç›®æ ‡/çŠ¶æ€å¯¹è±¡
    window.goal = {
        westernMedStudyHours: 0, 
        rareTitle: "" 
    };
    // ç›®æ ‡å¸¸é‡
    const WESTERN_MED_GOAL = 50;
    const RARE_TITLE_NAME = "â˜… å¤©æ¶¯åŒ»å¥³ â˜…";

    // å·¥å…·å‡½æ•°
    function getSyncDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function getDisplayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    function totalScore(){
        return window.attr.health + window.attr.stamina + window.attr.tidiness + window.attr.will + window.attr.mind + window.attr.wisdom;
    }

    function levelName(){
        const t = totalScore();
        if(t>=150) return "å¤§æˆ";
        if(t>=100) return "ä½³äºº";
        if(t>=60) return "çŸ¥å¥³";
        if(t>=30) return "æ‰å¥³";
        return "å©‰å¥³";
    }
    
    function updateGoalDisplay(){
        const currentHours = window.goal.westernMedStudyHours;
        const goalHours = WESTERN_MED_GOAL;
        const display = document.getElementById('westernMedGoalDisplay');
        const titleDisplay = document.getElementById('westernMedTitleDisplay');
        
        if(window.goal.rareTitle === RARE_TITLE_NAME){
            titleDisplay.innerHTML = `<span style="color:red; font-weight:bold;">ç¨€æœ‰ç§°å·ï¼š${RARE_TITLE_NAME} (å·²è·å¾—)</span>`;
            display.innerText = `è¥¿åŒ»å­¦è¿›åº¦ï¼šå·²è¾¾æˆï¼ˆ${currentHours.toFixed(2)} / ${goalHours} å°æ—¶ï¼‰`;
        } else {
            titleDisplay.innerText = `ç¨€æœ‰ç§°å·ï¼š${RARE_TITLE_NAME} (æœªè·å¾—)`; 
            display.innerText = `è¥¿åŒ»å­¦è¿›åº¦ï¼š${Math.min(currentHours, goalHours).toFixed(2)} / ${goalHours} å°æ—¶`;
        }
    }

    function updateDisplay(){
        let scoreTitle = `å½“å‰ç­‰çº§ï¼š${levelName()}ã€€æ€»ç§¯åˆ†ï¼š${Math.round(totalScore())}`;
        if (window.goal.rareTitle) {
            scoreTitle += `ã€€${window.goal.rareTitle}`;
        }
        document.getElementById('scoreBoard').innerText = scoreTitle;
        document.getElementById('healthVal').innerText = window.attr.health.toFixed(1);
        document.getElementById('staminaVal').innerText = window.attr.stamina.toFixed(1);
        document.getElementById('tidinessVal').innerText = window.attr.tidiness.toFixed(1);
        document.getElementById('willVal').innerText = window.attr.will.toFixed(1);
        document.getElementById('mindVal').innerText = window.attr.mind.toFixed(1);
        document.getElementById('wisdomVal').innerText = window.attr.wisdom.toFixed(1);
        updateGoalDisplay();
    }
    window.updateDisplay = updateDisplay;

    function addTip(text){
        const tipBox = document.getElementById('tipBox');
        const p = document.createElement('div');
        const date = getDisplayDate();  
        p.innerText = `[${date}] ${text}`;
        tipBox.prepend(p);
    }
    window.addTip = addTip;
    
    window.lastDailyTipDate = "";

    function showDailyTip(fromLoadGame = false) {
        const todaySyncDate = getSyncDate();
        const todayDisplayDate = getDisplayDate();
        const dailyTip = "ğŸŒ¸ æ¸…æ™¨å¾®å…‰ï¼Œé™å€™ä¿®è¡Œå§‹ã€‚";
        const tipBox = document.getElementById('tipBox');
        
        if (window.lastDailyTipDate !== todaySyncDate) {
            const p = document.createElement('div');
            p.innerText = `[${todayDisplayDate}] ${dailyTip}`;
            tipBox.prepend(p);
            console.log(`[${todaySyncDate}] æ–°çš„ä¸€å¤©ï¼Œå·²æ·»åŠ æ¯æ—¥æç¤ºã€‚`);
            window.lastDailyTipDate = todaySyncDate;
            if (window.saveGameData) {
                window.saveGameData(true, true);
            }
        }   
        else if (fromLoadGame && tipBox.children.length === 0) {
            addTip("ğŸ™ å­˜æ¡£åŠ è½½å®Œæ¯•ï¼Œç»§ç»­æ‚¨çš„ä¿®å¿ƒä¹‹æ—…ã€‚");
        }
    }
    window.showDailyTip = showDailyTip;

    updateDisplay();
    window.addEventListener('load', () => showDailyTip(false)); 
    
    function checkWesternMedGoal() {
        if (window.goal.westernMedStudyHours >= WESTERN_MED_GOAL && window.goal.rareTitle === "") {
            window.goal.rareTitle = RARE_TITLE_NAME;
            addTip(`ğŸ‰ **æ­å–œï¼æ‚¨å·²æˆåŠŸå®Œæˆè¥¿å­¦å…¥é“ ${WESTERN_MED_GOAL} å°æ—¶ç ”ä¹ ï¼Œè·å¾—ç¨€æœ‰ç§°å·ã€${RARE_TITLE_NAME}ã€‘ï¼**`);
        }
    }

    function study(){
        const subject = document.getElementById('subject').value;
        let hour = parseFloat(document.getElementById('studyHour').value) || 0;
        let min = parseFloat(document.getElementById('studyMin').value) || 0;
        let totalHour = hour + min/60;
        if(totalHour <= 0){ addTip("æ— å¿ƒäºä¹¦å·ï¼Œæ—¶å…‰æ‚„ç„¶æºœèµ°â€¦â€¦"); return; }
        let gain = totalHour * 3;
        window.attr.wisdom += gain;
        window.attr.will += gain * 0.5;
        if (subject === 'è¥¿åŒ»å­¦') {
            window.goal.westernMedStudyHours += totalHour;
            checkWesternMedGoal();
        }
        const studyTips = [
            `ç¯ä¸‹æŒ‘ç¯ç ”è¯»ã€Š${subject}ã€‹ï¼Œç¬”å¢¨ç”Ÿé¦™ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`,
            `è½»å¯ä¹¦å·ï¼Œæ˜¥é£æ‹‚é¢ï¼Œç ”ä¹ ã€Š${subject}ã€‹æœ‰æˆï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`,
            `å¤œæ·±ç¯ç«ï¼Œå€©å½±ç ”è¯»ï¼Œã€Š${subject}ã€‹å¦‚è¯—å¦‚ç”»ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`,
            `çª—å¤–æœˆå…‰å¦‚æ°´ï¼Œæ¡Œä¸Šä¹¦é¦™æ‰‘é¼»ï¼Œã€Š${subject}ã€‹ä¸­çš„å¥¥ç§˜æ¸æ¸æ˜äº†ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`
        ];
        addTip(studyTips[Math.floor(Math.random() * studyTips.length)]);
        updateDisplay();
    }
    window.study = study;

    function noStudy(){
        window.attr.will -= 1;
        window.attr.wisdom -= 1;
        addTip("ä¸€æ—¥å·æ‡’ï¼Œä¹¦å·è’™å°˜ï¼Œæ‚Ÿæ€§ï¼1ï¼Œæ„å¿—ï¼1ã€‚");
        updateDisplay();
    }
    window.noStudy = noStudy;

    function eat(type){
        if(type === 'å¥åº·'){
            window.attr.health += 1;
            addTip("é’è”¬æ·¡é¥­ï¼Œæ¸…å¿ƒå¯¡æ¬²ï¼Œæ°”è¡€è°ƒå’Œï¼Œå¥åº·ï¼‹1ã€‚");
        } else {
            window.attr.health -= 2;
            addTip("æ²¹ç‚¸å¥¶èŒ¶æ³¡é¢å…¥è…¹ï¼Œè„¾èƒƒä¸é€‚ï¼Œå¥åº·ï¼2ã€‚");
        }
        updateDisplay();
    }
    window.eat = eat;

    function exercise(type){
        let tip;
        if(type === "æŒé‡é”»ä½“"){
            window.attr.stamina += 1.5;
            window.attr.health += 1;
            tip = [ "ä¸¾é“å¦‚å±±ï¼Œæ°”è¡€ç•…é€šï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚", "æ²‰å¿ƒé”¤ç‚¼ï¼Œç­‹éª¨èˆ’å±•ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚", "åŠ›è¡Œé”»ä½“ï¼Œæ°”è¡€æµç•…ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚" ];
        }
        if(type === "ä¿®èº«å…»æ€§"){
            window.attr.stamina += 1;
            window.attr.will += 0.5;
            tip = [ "è½»èˆ’è…°è‚¢ï¼Œæ°”å®šç¥é—²ï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚", "è…°èº«è½»æ—‹ï¼Œå¿ƒé™å¦‚æ°´ï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚", "é™å¿ƒå…»æ€§ï¼Œèˆ’å±•èº«å¿ƒï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚" ];
        }
        if(type === "èˆ’ç­‹æ´»ç»œ"){
            window.attr.health += 1;
            window.attr.mind += 0.5;
            tip = [ "ç­‹éª¨èˆ’å±•ï¼Œå¿ƒå¢ƒæ¸…å®ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚", "è½»è½»èˆ’å±•ï¼Œèº«å¿ƒæ„‰æ‚¦ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚", "ç­‹éª¨ç•…é€šï¼Œæ°”è¡€æµåŠ¨ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚" ];
        }
        if(type === "èˆåŠ¨é£å"){
            window.attr.stamina += 1.2;
            window.attr.health += 0.7;
            tip = [ "èˆåŠ¨é£åï¼Œæ°”è¡€æµç•…ï¼Œèº«å¿ƒåˆä¸€ï¼Œä½“åŠ›ï¼‹1.2ï¼Œå¥åº·ï¼‹0.7ã€‚", "èˆæ­¥è½»ç›ˆï¼Œç¥é‡‡å¥•å¥•ï¼Œä½“åŠ›ï¼‹1.2ï¼Œå¥åº·ï¼‹0.7ã€‚", "èˆå§¿ç¿©è·¹ï¼Œæ°”è¡€é¡ºç•…ï¼Œä½“åŠ›ï¼‹1.2ï¼Œå¥åº·ï¼‹0.7ã€‚" ];
        }
        addTip(tip[Math.floor(Math.random() * tip.length)]);
        updateDisplay();
    }
    window.exercise = exercise;

    function cook(){
        window.attr.health += 1;
        window.attr.will += 0.5;
        addTip("äº²æ‰‹çƒ¹è°ƒï¼Œé¦™æ°”å››æº¢ï¼Œé£Ÿå…»èº«å¿ƒï¼Œå¥åº·ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚");
        updateDisplay();
    }
    window.cook = cook;

    function clean(){
        window.attr.tidiness += 1;
        window.attr.stamina += 0.5;
        addTip("æ‰«å»å°˜åŸƒï¼Œæ˜çª—å‡€å‡ ï¼Œå¿ƒå¢ƒæ¾„æ˜ï¼Œæ•´æ´ï¼‹1ï¼Œä½“åŠ›ï¼‹0.5ã€‚");
        updateDisplay();
    }
    window.clean = clean;

    function groom(type){
        let tip;
        if(type==="åŒ–å¦†"){ window.attr.will += 1; tip = "è½»æ–½ç²‰é»›ï¼Œæ˜çœ¸å–„çï¼Œç¥é‡‡å¥•å¥•ï¼Œæ„å¿—ï¼‹1ã€‚"; }
        if(type==="åˆ·ç‰™"){ window.attr.tidiness += 0.5; tip = "å£é½¿æ¸…èŠ¬ï¼Œå¦‚ç‰ç”Ÿè¾‰ï¼Œæ•´æ´ï¼‹0.5ã€‚"; }
        if(type==="æ´—æ¾¡"){ window.attr.tidiness += 1; tip = "æ¸©æ³‰è½»é›¾ï¼Œæ´—å»ç–²ä¹ï¼Œèº«å¿ƒä¿±å‡€ï¼Œæ•´æ´ï¼‹1ã€‚"; }
        addTip(tip);
        updateDisplay();
    }
    window.groom = groom;

    function chant(){
        window.attr.mind += 0.5;
        window.attr.will += 0.5;
        addTip("é™å¿ƒè¯µç»ï¼Œå¿ƒçµæ¾„å‡€ï¼Œå¿ƒæ€§ï¼‹0.5ï¼Œå®šåŠ›ï¼‹0.5ã€‚");
        updateDisplay();
    }
    window.chant = chant;

    function noChant(){
        window.attr.will -= 1;
        window.attr.mind -= 1;
        addTip("å¿ƒæµ®æ°”èºï¼Œå¿µç»ä¸ä¸“ï¼Œå¿ƒæ€§ï¼1ï¼Œå®šåŠ›ï¼1ã€‚");
        updateDisplay();
    }
    window.noChant = noChant;
</script>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAaLeQq_L5JUSQpZ_0jQlHeWm3pXnoxd5g",
      authDomain: "mylifeproject-4712e.firebaseapp.com",
      projectId: "mylifeproject-4712e",
      storageBucket: "mylifeproject-4712e.firebasestorage.app",
      messagingSenderId: "326417385505",
      appId: "1:326417385505:web:f352dacda0da35fb17bb60"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    let currentUser = null;
    let isDataLoaded = false; // ã€å®‰å…¨é”ï¼šæ ‡è®°æ•°æ®æ˜¯å¦å·²åŠ è½½ã€‘

    function getTipsFromDisplay() {
        const tipBox = document.getElementById('tipBox');
        const children = Array.from(tipBox.children);
        return children.map(child => child.innerText);
    }

    function displayTips(tipsArray) {
        const tipBox = document.getElementById('tipBox');
        tipBox.innerHTML = '';
        [...tipsArray].reverse().forEach(tipText => {
            const p = document.createElement('div');
            p.innerText = tipText;
            tipBox.prepend(p);
        });
        const greeting = document.createElement('div');
        greeting.innerText = `--- [${new Date().toLocaleString('zh-CN')}] å­˜æ¡£åŠ è½½å®Œæˆ ---`;
        tipBox.prepend(greeting);
    }

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loadGameData(true);
        } else {
            currentUser = null;
            isDataLoaded = false;
        }
    });

    function registerWithEmail() {
        const email = prompt("è¯·è¾“å…¥æ‚¨çš„é‚®ç®±");
        const password = prompt("è¯·è¾“å…¥æ‚¨çš„å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰");
        if (!email || !password) {
            alert("é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }
        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                alert("æ³¨å†ŒæˆåŠŸï¼Œå·²ä¸ºæ‚¨ä¿å­˜åˆå§‹è¿›åº¦ï¼");
                Object.assign(window.attr, {health: 0, stamina: 0, tidiness: 0, will: 0, mind: 0, wisdom: 0});
                Object.assign(window.goal, {westernMedStudyHours: 0, rareTitle: ""});
                window.lastDailyTipDate = window.getSyncDate();
                if (window.updateDisplay) window.updateDisplay();
                isDataLoaded = true; // æ³¨å†Œæ–°å·ï¼Œè§†ä¸ºæ•°æ®å·²å°±ç»ª
                saveGameData(true);
            })
            .catch((error) => {
                console.error("æ³¨å†Œå¤±è´¥", error);
                alert(`æ³¨å†Œå¤±è´¥: ${error.message}`);
            });
    }

    function loginWithEmail() {
        const email = prompt("è¯·è¾“å…¥æ‚¨çš„é‚®ç®±");
        const password = prompt("è¯·è¾“å…¥æ‚¨çš„å¯†ç ");
        if (!email || !password) {
            alert("é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }
        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                // ç™»å½•æˆåŠŸåï¼ŒloadGameData ä¼šè‡ªåŠ¨è¢«è§¦å‘
                alert("ç™»å½•æˆåŠŸï¼Œæ­£åœ¨åŠ è½½å­˜æ¡£...");
            })
            .catch((error) => {
                console.error("ç™»å½•å¤±è´¥", error);
                alert(`ç™»å½•å¤±è´¥: ${error.message}`);
            });
    }

    async function saveGameData(isInitialSave = false, isDateOnlySave = false) {
        if (!currentUser) {
            if (!isDateOnlySave) alert("è¯·å…ˆç™»å½•æˆ–æ³¨å†Œæ‰èƒ½ä¿å­˜æ•°æ®ï¼");
            return;
        }

        // ã€å®‰å…¨æ£€æŸ¥ã€‘å¦‚æœä¸æ˜¯åˆå§‹ä¿å­˜ï¼Œä¹Ÿä¸æ˜¯ä»…æ—¥æœŸä¿å­˜ï¼Œä¸”æ•°æ®è¿˜æ²¡åŠ è½½å®Œï¼Œç¦æ­¢ä¿å­˜ï¼
        if (!isInitialSave && !isDateOnlySave && !isDataLoaded) {
            alert("âš ï¸ å±é™©ï¼šäº‘ç«¯å­˜æ¡£å°šæœªåŠ è½½å®Œæˆï¼\nä¸ºäº†é˜²æ­¢è¦†ç›–æ‚¨çš„æ—§å­˜æ¡£ï¼Œè¯·ç­‰å¾…åŠ è½½å®Œæ¯•ï¼Œæˆ–åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
            return;
        }

        const userDocRef = doc(db, "users", currentUser.uid);
        if (typeof window.attr !== 'object' || window.attr === null) {
              console.error("æ— æ³•ä¿å­˜ï¼šwindow.attr ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡");
              return;
        }

        const dataToSave = {
            attributes: window.attr,
            goals: window.goal,
            tips: getTipsFromDisplay(),
            lastSave: new Date().toLocaleString('zh-CN'),
            lastDailyTipDate: window.lastDailyTipDate || "",
        };

        try {
            // ã€å®‰å…¨ä¿å­˜ã€‘ä½¿ç”¨ merge: true é˜²æ­¢è¦†ç›–å…¶ä»–å­—æ®µ
            await setDoc(userDocRef, dataToSave, { merge: true });
            if (!isInitialSave && !isDateOnlySave) {
                alert("æ¸¸æˆæ•°æ®ä¿å­˜æˆåŠŸï¼");
            }
        } catch (e) {
            console.error("æ•°æ®å†™å…¥å¤±è´¥ï¼š", e);
            if (!isDateOnlySave) alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
        }
    }

    async function loadGameData(isAutoLoad = false) {
        if (!currentUser) return;
        const userDocRef = doc(db, "users", currentUser.uid);
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                if(data.attributes) Object.assign(window.attr, data.attributes);
                if(data.goals) {
                    Object.assign(window.goal, data.goals);
                } else {
                    Object.assign(window.goal, {westernMedStudyHours: 0, rareTitle: ""});
                }

                if (window.updateDisplay) window.updateDisplay();

                if (data.tips && Array.isArray(data.tips)) {
                    displayTips(data.tips);
                } else {
                    displayTips([]);
                    const welcomeMsg = document.createElement('div');
                    welcomeMsg.innerText = `[${new Date().toLocaleString('zh-CN')}] æ¬¢è¿å›æ¥ï¼Œ${currentUser.email}ï¼æœªæ‰¾åˆ°å†å²è®°å½•ï¼Œè¯·ç»§ç»­ä¿®è¡Œã€‚`;
                    document.getElementById('tipBox').prepend(welcomeMsg);
                }
                
                window.lastDailyTipDate = data.lastDailyTipDate || "";
                
                // ã€å…³é”®ã€‘æ ‡è®°æ•°æ®å·²åŠ è½½æˆåŠŸï¼Œæ­¤æ—¶æ‰å¯ä»¥ä¿å­˜
                isDataLoaded = true; 
                console.log("å­˜æ¡£åŠ è½½å®Œæ¯•ï¼Œè§£é”ä¿å­˜åŠŸèƒ½ã€‚");

                if (window.showDailyTip) window.showDailyTip(true);
            } else if (!isAutoLoad) {
                alert("æœªæ‰¾åˆ°æ‚¨çš„æ¸¸æˆå­˜æ¡£ï¼Œè¯·è¿›è¡Œæ¸¸æˆæ“ä½œåç‚¹å‡»ã€ä¿å­˜è¿›åº¦ã€‘ï¼");
                // å³ä½¿æ²¡æ‰¾åˆ°å­˜æ¡£ï¼ˆæ–°ç”¨æˆ·ï¼‰ï¼Œä¹Ÿè§†ä¸ºåŠ è½½è¿‡ç¨‹ç»“æŸ
                isDataLoaded = true; 
            }
        } catch (e) {
            console.error("æ•°æ®è¯»å–å¤±è´¥ï¼š", e);
            isDataLoaded = false; // åŠ è½½å¤±è´¥ï¼Œä¿æŒé”å®š
            if (!isAutoLoad) {
                alert("æ•°æ®è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
            }
        }
    }

    window.registerWithEmail = registerWithEmail;
    window.loginWithEmail = loginWithEmail;
    window.saveGameData = saveGameData;
</script>
</body>
</html>