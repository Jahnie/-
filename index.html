<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>ä¿®å¿ƒå…»æ€§è®°</title>
<style>
/* ================================================= */
/* ã€CSS æ ·å¼ï¼šç¬¬äºŒç‰ˆä¿®æ”¹ã€‘ - æ¢å¤ç‹¬ç«‹æ»šåŠ¨åŒº */
/* ================================================= */
body {
    background: #f8f4ef;
    font-family: "å®‹ä½“";
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: flex-start;
    /* æ¢å¤ 100vh å’Œ padding æ¥æ§åˆ¶æ•´ä½“å¸ƒå±€ */
    height: 100vh; 
    padding: 20px;
}

/* æ–°å¢ï¼šæ—¥å¿—å’ŒæŒ‰é’®çš„å®¹å™¨ï¼Œç”¨äºæ§åˆ¶ç‹¬ç«‹æ»šåŠ¨åŒºåŸŸçš„é«˜åº¦ */
#logContainer {
    width: 40%;
    display: flex;
    flex-direction: column; 
    height: 100%; 
}

#loginSection {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 0; /* è°ƒæ•´ä¸º 0 */
    
    border: none;
    background: #f9e6ea;
    background-color: #f9e6ea;
    border: 1px solid #e4b6c2;
    color: #704848;
    padding: 10px 15px; 
    border-radius: 10px 10px 0 0; 
}

#tipBox {
    /* tipBox å¡«å……å‰©ä½™ç©ºé—´ */
    flex-grow: 1; 
    
    background: #fff8f2;
    border: 2px solid #cbb8a5;
    border-radius: 0 0 10px 10px; 
    padding: 15px;
    color: #5c4631;
    line-height: 1.8;
    font-size: 16px;
    box-shadow: 0 0 6px #e0d1be;
    
    /* æ¢å¤ tipBox å†…éƒ¨æ»šåŠ¨ */
    overflow-y: auto; 
}

#main {
    width: 50%;
    margin-left: 30px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* å…¶ä»–æ ·å¼ä¿æŒä¸å˜ */
button {
    background: #f9e6ea;
    border: none;
    padding: 2px 7px;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
}
button:hover {
    background: #d7c1a8;
}
.section {
    background: #fffdf8;
    border: 1px solid #d2c0a8;
    border-radius: 3px;
    padding: 15px;
}
#scoreBoard {
    font-weight: bold;
    color: #4b3823;
    margin-bottom: 5px;
}
#attrBoard {
    background: #fefaf5;
    border: 1px solid #d6c4aa;
    border-radius: 10px;
    padding: 10px;
    margin-bottom: 8px;
    font-size: 15px;
    color: #5c4631;
}
.attr-line {
    display: flex;
    justify-content: space-between;
    padding: 2px 0;
}
h3 {
    font-size: 18px;
    margin: 0px 0 7px;
    padding-left: 10px;
}
</style>
</head>
<body>

<div id="logContainer">
    <div id="loginSection">
        <button onclick="registerWithEmail()">æ³¨å†Œ</button>
        <button onclick="loginWithEmail()">ç™»å½•</button>
        <button onclick="saveGameData()">ä¿å­˜è¿›åº¦</button>
    </div>

    <div id="tipBox" class="tip-content">
        </div>
</div>

<div id="main">
    <div id="scoreBoard">å½“å‰ç­‰çº§ï¼šå©‰å¥³ã€€æ€»ç§¯åˆ†ï¼š0</div>
    <div id="attrBoard">
        <div class="attr-line"><span>ğŸŒ¿ å¥åº·ï¼š</span><span id="healthVal">0</span></div>
        <div class="attr-line"><span>ğŸ”¥ ä½“åŠ›ï¼š</span><span id="staminaVal">0</span></div>
        <div class="attr-line"><span>ğŸ§º æ•´æ´ï¼š</span><span id="tidinessVal">0</span></div>
        <div class="attr-line"><span>ğŸª æ„å¿—ï¼š</span><span id="willVal">0</span></div>
        <div class="attr-line"><span>ğŸ•Šï¸ å¿ƒæ€§ï¼š</span><span id="mindVal">0</span></div>
        <div class="attr-line"><span>ğŸ“œ æ‚Ÿæ€§ï¼š</span><span id="wisdomVal">0</span></div>
    </div>

    <div class="section">
        <h3>ğŸ“– å­¦ä¹ </h3>
        <select id="subject">
            <option>ä¸­åŒ»å­¦</option>
            <option>é’ˆç¸å­¦</option>
            <option>è¥¿åŒ»å­¦</option>
            <option>è‹±æ–‡</option>
        </select>
        <input id="studyHour" type="number" placeholder="å°æ—¶" min="0" style="width:50px;">æ—¶
        <input id="studyMin" type="number" placeholder="åˆ†é’Ÿ" min="0" style="width:60px;">åˆ†
        <button onclick="study()">ä¿®ä¹ </button>
        <button onclick="noStudy()">å·æ‡’ä¸€æ—¥</button>
    </div>

    <div class="section">
        <h3>ğŸ¥£ é¥®é£Ÿ</h3>
        <button onclick="eat('å¥åº·')">è†³é£Ÿæ¸…æ·¡</button>
        <button onclick="eat('åƒåœ¾')">æ²¹ç‚¸å¥¶èŒ¶æ³¡é¢</button>
    </div>

    <div class="section">
        <h3>ğŸ’ª è¿åŠ¨</h3>
        <button onclick="exercise('æŒé‡é”»ä½“')">æŒé‡é”»ä½“ï¼ˆä¸¾å“‘é“ƒï¼‰</button>
        <button onclick="exercise('ä¿®èº«å…»æ€§')">ä¿®èº«å…»æ€§ï¼ˆè…°éƒ¨é”»ç‚¼ï¼‰</button>
        <button onclick="exercise('èˆ’ç­‹æ´»ç»œ')">èˆ’ç­‹æ´»ç»œï¼ˆæ‹‰ä¼¸ï¼‰</button>
        <button onclick="exercise('èˆåŠ¨é£å')">èˆåŠ¨é£åï¼ˆå¥èº«æ“ï¼‰</button>
    </div>

    <div class="section">
        <h3>ğŸ¡ æ—¥å¸¸</h3>
        <button onclick="cook()">çƒ¹é¥ªè†³é£Ÿ</button>
        <button onclick="clean()">æ‰“æ‰«æˆ¿é—´</button>
    </div>

    <div class="section">
        <h3>ğŸª ä»ªå®¹</h3>
        <button onclick="groom('åŒ–å¦†')">æ–½ç²‰é»›</button>
        <button onclick="groom('åˆ·ç‰™')">æ™¨èµ·ç›¥æ´—</button>
        <button onclick="groom('æ´—æ¾¡')">æ²æµ´æ›´è¡£</button>
    </div>

    <div class="section">
        <h3>ğŸ•‰ï¸ å¿µç»</h3>
        <button onclick="chant()">å¿µç»ä¿®è¡Œ</button>
        <button onclick="noChant()">æ€ æ…¢ä¿®è¡Œ</button>
        </div>
</div>
<script>
    // 1. å®šä¹‰å…¨å±€å±æ€§å¯¹è±¡
    window.attr = {
        health: 0,
        stamina: 0,
        tidiness: 0,
        will: 0,
        mind: 0,
        wisdom: 0
    };
    
    // å·¥å…·å‡½æ•°
    // ã€æ–°å¢/ä¿®æ”¹ã€‘ç”¨äºè·¨è®¾å¤‡åŒæ­¥çš„æ—¥æœŸæ ¼å¼ (YYYY-MM-DD)
    function getSyncDate() {
        const now = new Date();
        const year = now.getFullYear();
        // ç¡®ä¿æœˆä»½å’Œæ—¥æœŸæ˜¯ä¸¤ä½æ•° (ä¾‹å¦‚ 01, 09)
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;	
    }

    // ã€æ–°å¢ã€‘æœ¬åœ°æ˜¾ç¤ºæ—¥æœŸï¼šç”¨äºåœ¨å±å¹•ä¸Šç»™ç”¨æˆ·çœ‹ (YYYYå¹´MæœˆDæ—¥)
    function getDisplayDate() {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const day = now.getDate();
        return `${year}å¹´${month}æœˆ${day}æ—¥`;
    }

    function totalScore(){
        return window.attr.health + window.attr.stamina + window.attr.tidiness + window.attr.will + window.attr.mind + window.attr.wisdom;
    }

    function levelName(){
        const t = totalScore();
        if(t>=150) return "å¤§æˆ";
        if(t>=100) return "ä½³äºº";
        if(t>=60) return "çŸ¥å¥³";
        if(t>=30) return "æ‰å¥³";
        return "å©‰å¥³";
    }

    // æ ¸å¿ƒæ˜¾ç¤ºå‡½æ•° (å·²æš´éœ²)
    function updateDisplay(){
        document.getElementById('scoreBoard').innerText =	
            `å½“å‰ç­‰çº§ï¼š${levelName()}ã€€æ€»ç§¯åˆ†ï¼š${Math.round(totalScore())}`;
        document.getElementById('healthVal').innerText = window.attr.health.toFixed(1);
        document.getElementById('staminaVal').innerText = window.attr.stamina.toFixed(1);
        document.getElementById('tidinessVal').innerText = window.attr.tidiness.toFixed(1);
        document.getElementById('willVal').innerText = window.attr.will.toFixed(1);
        document.getElementById('mindVal').innerText = window.attr.mind.toFixed(1);
        document.getElementById('wisdomVal').innerText = window.attr.wisdom.toFixed(1);
    }
    window.updateDisplay = updateDisplay;

    // æ ¸å¿ƒæç¤ºå‡½æ•° (å·²æš´éœ²) - ç”¨äºæ“ä½œæç¤º
    function addTip(text){
        const tipBox = document.getElementById('tipBox');
        const p = document.createElement('div');
        // ä½¿ç”¨æœ¬åœ°æ˜¾ç¤ºæ—¥æœŸ
        const date = getDisplayDate();	
        p.innerText = `[${date}] ${text}`;
        tipBox.prepend(p);
    }
    window.addTip = addTip;
    
    // ã€é‡è¦ã€‘ç”¨äºè·¨è®¾å¤‡åŒæ­¥çš„å…¨å±€å˜é‡
    window.lastDailyTipDate = "";

    // ã€æœ€ç»ˆä¿®å¤ç‰ˆæœ¬ã€‘ showDailyTip å‡½æ•°
    function showDailyTip(fromLoadGame = false) {
        const todaySyncDate = getSyncDate();	 	// ä¾‹å¦‚ "2025-11-06" (ç”¨äºåŒæ­¥)
        const todayDisplayDate = getDisplayDate();	// ä¾‹å¦‚ "2025å¹´11æœˆ6æ—¥" (ç”¨äºæ˜¾ç¤º)
        const dailyTip = "ğŸŒ¸ æ¸…æ™¨å¾®å…‰ï¼Œé™å€™ä¿®è¡Œå§‹ã€‚";
        const tipBox = document.getElementById('tipBox');
        
        // é€»è¾‘ï¼šå¦‚æœä»Šå¤©çš„åŒæ­¥æ—¥æœŸä¸ Firebase å­˜æ¡£ä¸­çš„åŒæ­¥æ—¥æœŸä¸åŒ
        // æ— è®ºå±å¹•ä¸Šæ˜¯å¦æœ‰å†å²è®°å½•ï¼Œåªè¦æ—¥æœŸä¸åŒï¼Œå°±è§†ä¸ºæ–°çš„ä¸€å¤©
        if (window.lastDailyTipDate !== todaySyncDate) {
            
            // 1. æ·»åŠ æ¯æ—¥æç¤º
            const p = document.createElement('div');
            // å…³é”®ï¼šä½¿ç”¨æ˜¾ç¤ºæ—¥æœŸæ ¼å¼
            p.innerText = `[${todayDisplayDate}] ${dailyTip}`;	
            tipBox.prepend(p);	
            console.log(`[${todaySyncDate}] æ–°çš„ä¸€å¤©ï¼Œå·²æ·»åŠ æ¯æ—¥æç¤ºã€‚`);

            // 2. æ›´æ–°å…¨å±€å˜é‡å’Œ Firebase
            window.lastDailyTipDate = todaySyncDate; // å­˜å‚¨ ISO æ ¼å¼
            
            if (window.saveGameData) {
                // isDateOnlySave=true, ç¡®ä¿æ—¥æœŸç«‹å³åŒæ­¥
                window.saveGameData(true, true);	
            }
        }	
        // åªæœ‰å½“ä» loadGame è¿‡æ¥ï¼Œä¸”æç¤ºæ¡†é‡Œç©ºäº†ï¼Œæ‰æ·»åŠ æ¬¢è¿è¯­
        else if (fromLoadGame && tipBox.children.length === 0) {
            addTip("ğŸ™ å­˜æ¡£åŠ è½½å®Œæ¯•ï¼Œç»§ç»­æ‚¨çš„ä¿®å¿ƒä¹‹æ—…ã€‚");
        }
    }
    window.showDailyTip = showDailyTip; // æš´éœ²ç»™æ¨¡å—è„šæœ¬ä½¿ç”¨

    // é¦–æ¬¡æ˜¾ç¤ºåˆå§‹åŒ–
    updateDisplay();
    // é¡µé¢åŠ è½½åè°ƒç”¨ä¸€æ¬¡ï¼Œä»¥é˜²æœªç™»å½•çŠ¶æ€
    window.addEventListener('load', () => showDailyTip(false));	
    

    // ğŸ“– å­¦ä¹ 
    function study(){
        const subject = document.getElementById('subject').value;
        let hour = parseFloat(document.getElementById('studyHour').value) || 0;
        let min = parseFloat(document.getElementById('studyMin').value) || 0;
        let totalHour = hour + min/60;
        if(totalHour <= 0){ addTip("æ— å¿ƒäºä¹¦å·ï¼Œæ—¶å…‰æ‚„ç„¶æºœèµ°â€¦â€¦"); return; }

        let gain = totalHour * 3;
        window.attr.wisdom += gain;
        window.attr.will += gain * 0.5;

        // éšæœºé€‰æ‹©å¤é£æç¤º
        const studyTips = [
            `ç¯ä¸‹æŒ‘ç¯ç ”è¯»ã€Š${subject}ã€‹ï¼Œç¬”å¢¨ç”Ÿé¦™ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`,
            `è½»å¯ä¹¦å·ï¼Œæ˜¥é£æ‹‚é¢ï¼Œç ”ä¹ ã€Š${subject}ã€‹æœ‰æˆï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`,
            `å¤œæ·±ç¯ç«ï¼Œå€©å½±ç ”è¯»ï¼Œã€Š${subject}ã€‹å¦‚è¯—å¦‚ç”»ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`,
            `çª—å¤–æœˆå…‰å¦‚æ°´ï¼Œæ¡Œä¸Šä¹¦é¦™æ‰‘é¼»ï¼Œã€Š${subject}ã€‹ä¸­çš„å¥¥ç§˜æ¸æ¸æ˜äº†ï¼Œæ‚Ÿæ€§ï¼‹${gain.toFixed(1)}ï¼Œæ„å¿—ï¼‹${(gain*0.5).toFixed(1)}ã€‚`
        ];
        addTip(studyTips[Math.floor(Math.random() * studyTips.length)]);
        updateDisplay();
    }
    window.study = study;

    function noStudy(){
        window.attr.will -= 1;
        window.attr.wisdom -= 1;
        addTip("ä¸€æ—¥å·æ‡’ï¼Œä¹¦å·è’™å°˜ï¼Œæ‚Ÿæ€§ï¼1ï¼Œæ„å¿—ï¼1ã€‚");
        updateDisplay();
    }
    window.noStudy = noStudy;

    // ğŸ¥£ é¥®é£Ÿ
    function eat(type){
        if(type === 'å¥åº·'){
            window.attr.health += 1;
            addTip("é’è”¬æ·¡é¥­ï¼Œæ¸…å¿ƒå¯¡æ¬²ï¼Œæ°”è¡€è°ƒå’Œï¼Œå¥åº·ï¼‹1ã€‚");
        } else {
            window.attr.health -= 2;
            addTip("æ²¹ç‚¸å¥¶èŒ¶æ³¡é¢å…¥è…¹ï¼Œè„¾èƒƒä¸é€‚ï¼Œå¥åº·ï¼2ã€‚");
        }
        updateDisplay();
    }
    window.eat = eat;

    // ğŸ’ª è¿åŠ¨
    function exercise(type){
        let tip;
        if(type === "æŒé‡é”»ä½“"){
            window.attr.stamina += 1.5;
            window.attr.health += 1;
            tip = [
                "ä¸¾é“å¦‚å±±ï¼Œæ°”è¡€ç•…é€šï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚",
                "æ²‰å¿ƒé”¤ç‚¼ï¼Œç­‹éª¨èˆ’å±•ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚",
                "åŠ›è¡Œé”»ä½“ï¼Œæ°”è¡€æµç•…ï¼Œä½“åŠ›ï¼‹1.5ï¼Œå¥åº·ï¼‹1ã€‚"
            ];
        }

        if(type === "ä¿®èº«å…»æ€§"){
            window.attr.stamina += 1;
            window.attr.will += 0.5;
            tip = [
                "è½»èˆ’è…°è‚¢ï¼Œæ°”å®šç¥é—²ï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚",
                "è…°èº«è½»æ—‹ï¼Œå¿ƒé™å¦‚æ°´ï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚",
                "é™å¿ƒå…»æ€§ï¼Œèˆ’å±•èº«å¿ƒï¼Œä½“åŠ›ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚"
            ];
        }

        if(type === "èˆ’ç­‹æ´»ç»œ"){
            window.attr.health += 1;
            window.attr.mind += 0.5;
            tip = [
                "ç­‹éª¨èˆ’å±•ï¼Œå¿ƒå¢ƒæ¸…å®ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚",
                "è½»è½»èˆ’å±•ï¼Œèº«å¿ƒæ„‰æ‚¦ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚",
                "ç­‹éª¨ç•…é€šï¼Œæ°”è¡€æµåŠ¨ï¼Œå¥åº·ï¼‹1ï¼Œå¿ƒæ€§ï¼‹0.5ã€‚"
            ];
        }

        if(type === "èˆåŠ¨é£å"){
            window.attr.stamina += 1.2;
            window.attr.health += 0.7;
            tip = [
                "èˆåŠ¨é£åï¼Œæ°”è¡€æµç•…ï¼Œèº«å¿ƒåˆä¸€ï¼Œä½“åŠ›ï¼‹1.2ï¼Œå¥åº·ï¼‹0.7ã€‚",
                "èˆæ­¥è½»ç›ˆï¼Œç¥é‡‡å¥•å¥•ï¼Œä½“åŠ›ï¼‹1.2ï¼Œå¥åº·ï¼‹0.7ã€‚",
                "èˆå§¿ç¿©è·¹ï¼Œæ°”è¡€é¡ºç•…ï¼Œä½“åŠ›ï¼‹1.2ï¼Œå¥åº·ï¼‹0.7ã€‚"
            ];
        }
        addTip(tip[Math.floor(Math.random() * tip.length)]);
        updateDisplay();
    }
    window.exercise = exercise;

    // ğŸ¡ æ—¥å¸¸
    function cook(){
        window.attr.health += 1;
        window.attr.will += 0.5;
        addTip("äº²æ‰‹çƒ¹è°ƒï¼Œé¦™æ°”å››æº¢ï¼Œé£Ÿå…»èº«å¿ƒï¼Œå¥åº·ï¼‹1ï¼Œæ„å¿—ï¼‹0.5ã€‚");
        updateDisplay();
    }
    window.cook = cook;

    function clean(){
        window.attr.tidiness += 1;
        window.attr.stamina += 0.5;
        addTip("æ‰«å»å°˜åŸƒï¼Œæ˜çª—å‡€å‡ ï¼Œå¿ƒå¢ƒæ¾„æ˜ï¼Œæ•´æ´ï¼‹1ï¼Œä½“åŠ›ï¼‹0.5ã€‚");
        updateDisplay();
    }
    window.clean = clean;

    // ğŸª ä»ªå®¹
    function groom(type){
        let tip;
        if(type==="åŒ–å¦†"){window.attr.will += 1; tip = "è½»æ–½ç²‰é»›ï¼Œæ˜çœ¸å–„çï¼Œç¥é‡‡å¥•å¥•ï¼Œæ„å¿—ï¼‹1ã€‚";}
        if(type==="åˆ·ç‰™"){window.attr.health += 0.5; tip = "æ¸…æ™¨ç›¥æ´—ï¼Œé½¿ç™½å¦‚ç‰ï¼Œç²¾ç¥ç„•å‘ï¼Œå¥åº·ï¼‹0.5ã€‚";}
        if(type==="æ´—æ¾¡"){window.attr.health += 1; tip = "æ¸©æ³‰è½»é›¾ï¼Œæ´—å»ç–²ä¹ï¼Œèº«å¿ƒä¿±å‡€ï¼Œå¥åº·ï¼‹1ã€‚";}
        addTip(tip);
        updateDisplay();
    }
    window.groom = groom;

    // ğŸ•‰ï¸ å¿µç»
    function chant(){
        window.attr.mind += 0.5;
        window.attr.will += 0.5;
        addTip("é™å¿ƒè¯µç»ï¼Œå¿ƒçµæ¾„å‡€ï¼Œå¿ƒæ€§ï¼‹0.5ï¼Œå®šåŠ›ï¼‹0.5ã€‚");
        updateDisplay();
    }
    window.chant = chant;

    function noChant(){
        window.attr.will -= 1;
        window.attr.mind -= 1;
        addTip("å¿ƒæµ®æ°”èºï¼Œå¿µç»ä¸ä¸“ï¼Œå¿ƒæ€§ï¼1ï¼Œå®šåŠ›ï¼1ã€‚");
        updateDisplay();
    }
    window.noChant = noChant;
</script>


<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Firebase é…ç½®
    const firebaseConfig = {
      apiKey: "AIzaSyAaLeQq_L5JUSQpZ_0jQlHeWm3pXnoxd5g",
      authDomain: "mylifeproject-4712e.firebaseapp.com",
      projectId: "mylifeproject-4712e",
      storageBucket: "mylifeproject-4712e.firebasestorage.app",
      messagingSenderId: "326417385505",
      appId: "1:326417385505:web:f352dacda0da35fb17bb60"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);

    let currentUser = null;
    
    // ã€JS å‡½æ•°ä¿®æ”¹ã€‘
    function getTipsFromDisplay() {
        const tipBox = document.getElementById('tipBox');
        // ç°åœ¨ tipBox å†…éƒ¨å°±æ˜¯æ‰€æœ‰æ—¥å¿— div
        const children = Array.from(tipBox.children); 
        return children.map(child => child.innerText);
    }
    
    // ã€JS å‡½æ•°ä¿®æ”¹ã€‘
    function displayTips(tipsArray) {
        const tipBox = document.getElementById('tipBox');
        
        // ç›´æ¥æ¸…ç©º tipBox
        tipBox.innerHTML = '';	

        // æç¤ºä¿¡æ¯åº”è¯¥ä»ä¸‹å¾€ä¸Šï¼ˆæ—¶é—´é¡ºåºï¼‰æ˜¾ç¤º
        [...tipsArray].reverse().forEach(tipText => {
            const p = document.createElement('div');
            p.innerText = tipText;
            tipBox.prepend(p); // ä½¿ç”¨ prepend ç¡®ä¿æœ€æ–°æç¤ºåœ¨æœ€ä¸Šé¢
        });
        
        const greeting = document.createElement('div');
        greeting.innerText = `--- [${new Date().toLocaleString('zh-CN')}] å­˜æ¡£åŠ è½½å®Œæˆ ---`;
        tipBox.prepend(greeting);
    }

    // ç›‘å¬è®¤è¯çŠ¶æ€
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loadGameData(true);
        } else {
            currentUser = null;
        }
    });

    // ä½¿ç”¨é‚®ç®±æ³¨å†Œ
    function registerWithEmail() {
        const email = prompt("è¯·è¾“å…¥æ‚¨çš„é‚®ç®±");
        const password = prompt("è¯·è¾“å…¥æ‚¨çš„å¯†ç ï¼ˆè‡³å°‘6ä½ï¼‰");
        if (!email || !password) {
            alert("é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                alert("æ³¨å†ŒæˆåŠŸï¼Œå·²ä¸ºæ‚¨ä¿å­˜åˆå§‹è¿›åº¦ï¼");
                // ç¡®ä¿åˆå§‹ä¿å­˜çš„æ˜¯ 0 åˆ†æ•°æ®
                Object.assign(window.attr, {health: 0, stamina: 0, tidiness: 0, will: 0, mind: 0, wisdom: 0});
                // ä½¿ç”¨ ISO æ ¼å¼åŒæ­¥æ—¥æœŸ
                window.lastDailyTipDate = getSyncDate();	
                if (window.updateDisplay) window.updateDisplay();
                saveGameData(true);	
            })
            .catch((error) => {
                console.error("æ³¨å†Œå¤±è´¥", error);
                alert(`æ³¨å†Œå¤±è´¥: ${error.message}`);
            });
    }

    // ä½¿ç”¨é‚®ç®±ç™»å½•
    function loginWithEmail() {
        const email = prompt("è¯·è¾“å…¥æ‚¨çš„é‚®ç®±");
        const password = prompt("è¯·è¾“å…¥æ‚¨çš„å¯†ç ");
        if (!email || !password) {
            alert("é‚®ç®±å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼");
            return;
        }

        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                currentUser = userCredential.user;
                loadGameData(true);	
                alert("ç™»å½•æˆåŠŸï¼Œå­˜æ¡£å·²è‡ªåŠ¨åŠ è½½ï¼");
            })
            .catch((error) => {
                console.error("ç™»å½•å¤±è´¥", error);
                alert(`ç™»å½•å¤±è´¥: ${error.message}`);
            });
    }

    // ä¿å­˜æ¸¸æˆæ•°æ®å’Œ Tips åˆ° Firestore
    async function saveGameData(isInitialSave = false, isDateOnlySave = false) {
        if (!currentUser) {
            if (!isDateOnlySave) alert("è¯·å…ˆç™»å½•æˆ–æ³¨å†Œæ‰èƒ½ä¿å­˜æ•°æ®ï¼");
            return;
        }

        const userDocRef = doc(db, "users", currentUser.uid);	
        
        if (typeof window.attr !== 'object' || window.attr === null) {
              console.error("æ— æ³•ä¿å­˜ï¼šwindow.attr ä¸æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„å¯¹è±¡");
              if (!isDateOnlySave) alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚");
              return;
        }
        
        const dataToSave = {
            attributes: window.attr,
            tips: getTipsFromDisplay(),
            lastSave: new Date().toLocaleString('zh-CN'),
            // ã€å…³é”®ã€‘å­˜å‚¨ ISO æ ¼å¼çš„æ—¥æœŸ
            lastDailyTipDate: window.lastDailyTipDate || "",	
        };

        try {
            await setDoc(userDocRef, dataToSave);
            if (!isInitialSave && !isDateOnlySave) {
                alert("æ¸¸æˆæ•°æ®å’Œå†å²è®°å½•ä¿å­˜æˆåŠŸï¼");
            }
        } catch (e) {
            console.error("æ•°æ®å†™å…¥å¤±è´¥ï¼š", e);
            if (!isDateOnlySave) alert("æ•°æ®ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ– Firebase æƒé™ã€‚");
        }
    }
    
    // ä» Firestore è¯»å–æ¸¸æˆæ•°æ®å’Œ Tips
    async function loadGameData(isAutoLoad = false) {
        if (!currentUser) return;
        const userDocRef = doc(db, "users", currentUser.uid);	
        
        try {
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // 1. åŠ è½½å±æ€§å’Œå†å²è®°å½•
                if(data.attributes) {
                    Object.assign(window.attr, data.attributes);	
                    if (window.updateDisplay) window.updateDisplay();
                }
                if (data.tips && Array.isArray(data.tips)) {
                    displayTips(data.tips);
                } else {
                    displayTips([]);
                    const welcomeMsg = document.createElement('div');
                    welcomeMsg.innerText = `[${new Date().toLocaleString('zh-CN')}] æ¬¢è¿å›æ¥ï¼Œ${currentUser.email}ï¼æœªæ‰¾åˆ°å†å²è®°å½•ï¼Œè¯·ç»§ç»­ä¿®è¡Œã€‚`;
                    document.getElementById('tipBox').prepend(welcomeMsg);
                }
                
                // 2. åŠ è½½æ¯æ—¥æç¤ºæ—¥æœŸ
                // æ­¤æ—¶ window.lastDailyTipDate ä¸­åº”æ˜¯ ISO æ ¼å¼ (e.g., "2025-11-06")
                window.lastDailyTipDate = data.lastDailyTipDate || "";

                // ========== è°ƒè¯•æé†’ï¼šè‹¥ä»æ— æ³•è§¦å‘ï¼Œè¯·åœ¨ Firebase ä¸­æ‰‹åŠ¨å°† lastDailyTipDate æ”¹ä¸ºæ˜¨å¤©çš„ ISO æ ¼å¼ï¼ˆä¾‹å¦‚ï¼š2025-11-05ï¼‰==========
                
                // 3. æ£€æŸ¥å¹¶æ˜¾ç¤ºæ¯æ—¥æç¤º (ä¼ å…¥ true è¡¨ç¤ºæ˜¯ä»åŠ è½½å­˜æ¡£è¿‡æ¥çš„)
                if (window.showDailyTip) window.showDailyTip(true);	
                
            } else if (!isAutoLoad) {
                alert("æœªæ‰¾åˆ°æ‚¨çš„æ¸¸æˆå­˜æ¡£ï¼Œè¯·è¿›è¡Œæ¸¸æˆæ“ä½œåç‚¹å‡»ã€ä¿å­˜è¿›åº¦ã€‘ï¼");
            }
        } catch (e) {
            console.error("æ•°æ®è¯»å–å¤±è´¥ï¼š", e);
            if (!isAutoLoad) {
                alert("æ•°æ®è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚");
            }
        }
    }
    
    // *** å°†æ¨¡å—å†…çš„å‡½æ•°æš´éœ²ç»™å…¨å±€ä½œç”¨åŸŸ ***
    window.registerWithEmail = registerWithEmail;
    window.loginWithEmail = loginWithEmail;
    window.saveGameData = saveGameData;
</script>

</body>
</html>